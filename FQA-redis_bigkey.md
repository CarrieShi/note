# redis

### 为什么大量过期key会阻塞redis?

Redis是单线程的，即只有一个线程处理所有客户端请求。当Redis中存在大量过期的key，而且这些key在同一时间内被访问时，就会导致Redis的资源被耗尽，从而导致阻塞。

具体地说，当Redis中有大量过期的key时，Redis会启动一个专门的线程来清除这些过期的key。这个线程负责将过期key从内存中删除，并释放这些key占用的内存。这个过程称为内存回收。当内存回收时，Redis会阻塞I/O线程，从而导致所有请求都被挂起。

此外，在Redis进行内存回收时，删除过期key的时间会与其他内存回收操作发生竞争，如LRU算法中的key淘汰等。这些操作同时发生时，会导致Redis的性能下降，从而导致阻塞。

因此，当Redis中存在大量过期key时，需注意及时清理和调整过期时间，以避免对Redis服务器的性能产生负面影响。


### redis 内存回收

Redis的内存回收主要是通过两种机制实现，即过期key自动删除和内存淘汰。

过期key自动删除
Redis支持设置key的过期时间，当key过期时，Redis会自动删除该key。Redis在内存中存储的数据是以key-value的形式存储的，在查询key的时候，如果key已经过期，那么Redis就会删除这个key对应的value。

内存淘汰
Redis内存使用的是物理内存，当内存不足时，Redis会使用LRU算法来淘汰一些数据。LRU算法是Least Recently Used（最近最少使用）的缩写，主要思想是将最近最少使用的数据淘汰掉，从而腾出更多的内存空间。Redis支持多种LRU算法，如LRU、LFU、Random等。

同时，Redis还提供了一些配置参数来控制内存淘汰的策略和行为。例如maxmemory选项可以设置Redis的最大内存使用量，当内存使用量达到这个值时，Redis会采取指定的淘汰策略来释放内存空间。

一般来说，为了避免因内存回收导致Redis阻塞，可以在配置选项中设置合适的maxmemory选项，并使用适当的LRU算法来淘汰部分数据，从而保证Redis的性能和稳定性。


### redis bigkey

Redis大key是指在Redis中占用较大的空间、或者包含了大量子元素的key。大key会带来多方面的问题，例如：

内存占用问题：大key占用较大的内存空间，可能会导致Redis内存不足，出现OOM异常。

网络传输问题：大key在网络传输时需要消耗大量的带宽，可能会导致Redis网络延迟或者负载过高。

数据操作问题：对于大key的读写操作可能会比较耗时，降低Redis性能。

对于大key的处理，可以从以下几个方面入手：

查找大key：使用Redis命令scan对Redis中的所有key进行扫描，找出占用空间大的key。

拆分大key：对于包含大量子元素的key，可以将其拆分成多个小的子key，从而减少每个key的元素数量，降低访问时的性能开销。

压缩大key：对于占用较大的key，可以进行压缩处理，例如压缩字符串对象、使用Redis的List类型代替Hash类型等。

使用Redis集群：Redis集群可以将数据分散存储在多个节点上，从而降低单个节点存储的数据量，减少大key的影响。

总之，处理Redis大key需要综合考虑数据大小、访问频率、存储空间等多个因素，采取合适的方案进行优化。


### OOM异常

OOM (Out Of Memory)异常是指Redis在进行数据操作时出现内存不足的情况，无法继续进行操作而抛出的异常。在Redis中，当内存使用超过了最大内存限制或者操作过程中使用的临时内存超过了 Redis.conf配置文件中所设置的最大字节数时，就会触发OOM异常。

OOM异常的出现可能会导致Redis服务不可用，影响业务的正常运行。为避免OOM异常的发生，需要采取以下一些措施：

设置最大内存：在Redis配置文件中设置最大内存限制，避免 Redis 内存使用超过系统可承受的范围。

合理使用内存：对于大的数据集合可以分批处理，避免一次性大量占用内存；使用节约内存的数据类型，避免无节制地使用Hash等消耗空间较大的结构。

监控Redis内存使用情况：使用Redis自身提供的内存管理命令例如：info memory、MEMORY STATS等命令，定期查看Redis内存使用情况。

设置内存过期时间：使用Redis的过期模式可以自动清理过期的数据，释放 Redis 的内存空间。

总之，通过以上措施，可以有效降低Redis中OOM异常的发生率，保证服务的正常稳定运行。

### redis scan 查找大key
Redis的SCAN命令可以用来查找所有符合给定模式的键。如果数据集中存在大量的大key，那么在进行查找时可能会影响Redis的性能。

以下是使用SCAN命令来查找大key的步骤：

使用SCAN命令和MATCH选项来匹配所有符合给定模式的键：
```SCAN 0 MATCH *pattern* ```
得到所有符合条件的键后，使用OBJECT命令获取键值对的内存大小：
```OBJECT encoding key ```
 
如果键值对的内存大小超过了一定的阈值，那么就认为它是一个大key。
```
if size > threshold: 
    print(key) 
```
可以根据具体情况来设置阈值的大小，一般来说，100MB已经是一个比较合理的阈值。

需要注意的是，在执行SCAN命令时，Redis会将整个数据集分成多个小chunk进行查询，如果在执行过程中数据集被修改，那么查询结果可能会不完整或者重复。

因此，为了避免这种情况的产生，SCAN命令建议使用迭代方式进行查询，例如：
```
SCAN 0 MATCH *pattern* COUNT 1000 
 
SCAN 1000 MATCH *pattern* COUNT 1000 
 
```
每次执行SCAN命令时，都指定从哪个chunk开始，并且指定返回的key数量。在每次查询后将返回的游标值作为下一次查询时的起始游标。这样可以确保查询结果的完整性与准确性。

### SCAN 0 MATCH pattern
这是Redis SCAN命令的一种用法，用于匹配数据集中所有符合指定模式的键，其中pattern为匹配模式，可以使用通配符*和?。

例如，执行以下命令可以查找所有以"user_"开头的键：
```
SCAN 0 MATCH user_* 
```
执行以上命令后，Redis会返回一个游标数值和与模式匹配的一组键名，例如：
```
1) 13 
 
2) 1) "user_123" 
   2) "user_456" 
   3) "user_789" 
   ```
第一行返回的是下一次SCAN命令应该使用的游标位置，第二行返回的是匹配到的键名。

需要注意的是，由于SCAN命令的实现是通过遍历整个数据集，因此执行效率会比较低，特别是在数据集比较大时。因此在使用SCAN命令时，应该避免使用过于宽泛的匹配模式，尽量使用具体的键名进行查找。

### redis-cli -h 127.0.0.1 -p 6379 --bigkeys -i 0.1
这条redis-cli命令的作用是连接本地IP地址为127.0.0.1，端口号为6379的Redis服务器，并且使用-b参数来查找Redis数据库中占用内存最大的Key，-i参数用于设置命令之间的间隔时间为0.1秒，即每0.1秒执行一次命令。执行该命令后，命令行界面会输出当前数据库中内存占用最大的Key的相关信息，如Key名称、大小等。

### 上述命令为什么要 -i 0.1
在Redis中，如果对于一个比较庞大的Redis数据库，使用一些命令可能会耗费较长的时间，如scan或者keys命令。如果没有设置适当的间隔时间，这些命令的执行可能会导致Redis服务器在短时间内接收大量请求，从而对服务器造成较大的负载压力，甚至可能对服务器的性能和稳定性造成不良影响。

使用-i参数可以设置命令之间的间隔时间，可以使Redis服务器在接收到一组命令后，先执行前面的命令，然后等待指定的时间间隔后再执行下一组命令。这样可以避免服务器瞬间接收大量请求，减轻服务器的负载压力，同时也可以使命令的执行更加稳定和顺畅。

在这个例子中，使用-i 0.1参数可以将命令之间的间隔时间设置为0.1秒，即每隔0.1秒执行一次命令，可以让命令的执行更为平缓和稳定，并且不会对Redis服务器造成较大的负载压力。

